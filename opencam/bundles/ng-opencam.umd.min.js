!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core")):"function"==typeof define&&define.amd?define("ng-opencam",["exports","@angular/core"],t):t(e["ng-opencam"]={},e.ng.core)}(this,function(e,t){"use strict";var i=(r.decorators=[{type:t.Injectable,args:[{providedIn:"root"}]}],r.ctorParameters=function(){return[]},r.ngInjectableDef=t.ɵɵdefineInjectable({factory:function(){return new r},token:r,providedIn:"root"}),r);function r(){}function n(e,t){var i="function"==typeof Symbol&&e[Symbol.iterator];if(!i)return e;var r,n,o=i.call(e),a=[];try{for(;(void 0===t||0<t--)&&!(r=o.next()).done;)a.push(r.value)}catch(s){n={error:s}}finally{try{r&&!r.done&&(i=o["return"])&&i.call(o)}finally{if(n)throw n.error}}return a}var o={VIDEO:"video",PICTURE:"picture"},a={PLAY:"play",PAUSE:"pause",STOP:"stop"},s={HD:"hd",VGA:"vga",FHD:"fhd",DEFAULT:"default"},c=(Object.defineProperty(d.prototype,"framerate",{set:function(e){0<e&&e<=60&&(this._framerate=Math.abs(e))},enumerable:!0,configurable:!0}),Object.defineProperty(d.prototype,"videoSource",{set:function(e){this.isScanCompleted&&e&&(this._videoSource=e,this.stopStream(),this.initStream())},enumerable:!0,configurable:!0}),Object.defineProperty(d.prototype,"audioSource",{set:function(e){this.isScanCompleted&&(this._audioSource=e,this.stopStream(),this.initStream())},enumerable:!0,configurable:!0}),Object.defineProperty(d.prototype,"width",{set:function(e){null!==e?this._width=e:this.display="none"},enumerable:!0,configurable:!0}),Object.defineProperty(d.prototype,"height",{set:function(e){null!==e?this._height=e:this.display="none"},enumerable:!0,configurable:!0}),Object.defineProperty(d.prototype,"capture",{set:function(e){var t=this;e.subscribe(function(e){setTimeout(function(){if(t.stream)if(t._captureType===o.VIDEO)t.isRecording?t.stopRecording():t.startRecording();else{var e=t.captureStreamShot();e&&t.captureHandler(e)}},1e3*Math.abs(e))})},enumerable:!0,configurable:!0}),Object.defineProperty(d.prototype,"captureType",{set:function(e){this._captureType=e},enumerable:!0,configurable:!0}),Object.defineProperty(d.prototype,"streamState",{set:function(e){e&&(this._streamState=e,this.stream!==undefined&&null!==this.stream?e===a.PLAY?(this.video.play(),this.recorder&&this.recorder.resume()):e===a.PAUSE?(this.video.pause(),this.recorder&&this.recorder.pause()):e===a.STOP&&(this.video.pause(),this.recorder&&this.recorder.stop(),this.stopStream(),this.video.srcObject=null):e===a.PLAY&&0<this.videoSources.length&&this.initStream())},enumerable:!0,configurable:!0}),Object.defineProperty(d.prototype,"mediaConstraints",{set:function(e){e&&((this._mediaConstraints=e)===s.HD?(this.constraints.video.width={min:1280},this.constraints.video.height={min:720}):e===s.FHD?(this.constraints.video.width={min:1920},this.constraints.video.height={min:1080}):e===s.VGA?(this.constraints.video.width={min:640},this.constraints.video.height={min:480}):this.constraints&&this.constraints.video&&(this.constraints.video.width&&delete this.constraints.video.width,this.constraints.video.height&&delete this.constraints.video.height),this.stream&&this.stopStream()&&this.initStream())},enumerable:!0,configurable:!0}),Object.defineProperty(d.prototype,"filters",{set:function(e){this._filters=e,this.ctx&&(this.ctx.filter=e)},enumerable:!0,configurable:!0}),d.prototype.ngOnInit=function(){this.ctx=this.canvas.nativeElement.getContext("2d");var e=this.ctx.canvas.clientWidth,t=this.ctx.canvas.clientHeight;this.canvas.width=e,this.canvas.height=t,this.isScanCompleted=!1,this.initOpenCam()},d.prototype.initOpenCam=function(){var t=this;navigator.mediaDevices.ondevicechange=function(e){return t.scanCaptureDevices()},this.scanCaptureDevices()},d.prototype.scanCaptureDevices=function(){var t=this;navigator.mediaDevices.enumerateDevices().then(function(e){t.handleCaptureDevices(e)})["catch"](function(e){return t.errorHandler(e)})},d.prototype.sourceHandler=function(){this.videoSourceEvent.emit(this.videoSources),this.audioSourceEvent.emit(this.audioSources)},d.prototype.captureHandler=function(e){this.captureEvent.emit(e)},d.prototype.errorHandler=function(e){this.errorEvent.emit(e)},d.prototype.handleCaptureDevices=function(e){var t=0;this.videoSources=[],this.audioSources=[];for(var i=0;i<e.length;i++)"videoinput"===e[i].kind&&e[i].deviceId!==undefined&&(t++,this.videoSources.push({id:e[i].deviceId,label:e[i].label,kind:e[i].kind})),"audioinput"===e[i].kind&&e[i].deviceId!==undefined&&this.audioSources.push({id:e[i].deviceId,label:e[i].label,kind:e[i].kind});if(0===t){var r=new Error;r.name="No devices available",r.message="Useful devices not found during scan",this.errorHandler(r)}else this.sourceHandler();this.isScanCompleted=!0},d.prototype.initStream=function(){var t=this;if(0<this.videoSources.length)this._videoSource?this.currentVideoSource=this._videoSource:this.currentVideoSource=this.videoSources[0],this._audioSource?(this.currentAudioSource=this._audioSource,this.constraints.audio={deviceId:{exact:this.currentAudioSource.id}}):(this.currentAudioSource=null,this.constraints.audio=!1),this.constraints.video.deviceId={exact:this.currentVideoSource.id},navigator.mediaDevices.getUserMedia(this.constraints).then(function(e){t.video.addEventListener("loadedmetadata",function(){t.canvas.clientWidth=t.video.videoWidth,t.canvas.clientHeight=t.video.videoHeight}),t.video.addEventListener("play",function(){return t.drawToCanvas()}),t.stream=e,t.video.srcObject=t.stream,t.video.muted=!0,t.video.controls=!1,t._streamState===a.PLAY&&t.video.play()})["catch"](function(e){t.errorHandler(e)});else{var e=new Error;e.name="Video stream init failed",e.message="No devices available for stream",this.errorHandler(e)}},d.prototype.getAudioStream=function(){var e=new AudioContext,t=e.createMediaStreamSource(this.stream),i=e.createMediaStreamDestination();return t.connect(i),t.connect(e.destination),i.stream},d.prototype.startRecording=function(){var t=this;this.isRecording=!0;var e,i=this.canvas.nativeElement.captureStream(this._framerate);e=this._audioSource?new MediaStream(function r(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(n(arguments[t]));return e}(this.stream.getAudioTracks(),i.getTracks())):i,this.recorder=new MediaRecorder(e),this.frames=[],this.recorder.ondataavailable=function(e){return t.extractRecording(e)},this.recorder.start()},d.prototype.extractRecording=function(e){this.frames.push(e.data);var t=new Blob(this.frames,{type:"video/webm"}),i=URL.createObjectURL(t);this.captureHandler(i),this.recorder=null},d.prototype.stopRecording=function(){this.recorder.stop(),this.isRecording=!1},d.prototype.drawToCanvas=function(){var e=this;this.ctx.drawImage(this.video,0,0),setTimeout(function(){return e.drawToCanvas()},1e3/this._framerate)},d.prototype.captureStreamShot=function(){if(this.video){var e=document.createElement("canvas");return e.width=this.video.videoWidth,e.height=this.video.videoHeight,e.getContext("2d").drawImage(this.canvas.nativeElement,0,0),e.toDataURL()}},d.prototype.stopStream=function(){return this.stream&&this.stream.getTracks().forEach(function(e){e.stop()}),!(this.stream=null)},d.prototype.ngOnDestroy=function(){this.stopStream()},d.decorators=[{type:t.Component,args:[{selector:"ng-opencam",template:"<canvas [style.display]='this.display' #opencam [style.height]='this._height' [style.width]='this._width' [height]=\"this.video.videoHeight\" [width]=\"this.video.videoWidth\"></canvas>\n"}]}],d.ctorParameters=function(){return[]},d.propDecorators={captureEvent:[{type:t.Output}],videoSourceEvent:[{type:t.Output}],audioSourceEvent:[{type:t.Output}],errorEvent:[{type:t.Output}],framerate:[{type:t.Input}],videoSource:[{type:t.Input}],audioSource:[{type:t.Input}],width:[{type:t.Input}],height:[{type:t.Input}],capture:[{type:t.Input}],captureType:[{type:t.Input}],streamState:[{type:t.Input}],mediaConstraints:[{type:t.Input}],filters:[{type:t.Input}],canvas:[{type:t.ViewChild,args:["opencam",{"static":!0}]}]},d);function d(){this.captureEvent=new t.EventEmitter(!0),this.videoSourceEvent=new t.EventEmitter(!0),this.audioSourceEvent=new t.EventEmitter(!0),this.errorEvent=new t.EventEmitter(!0),this._framerate=30,this._audioSource=null,this.video=document.createElement("video"),this.videoSources=[],this.audioSources=[],this.constraints={audio:{},video:{}}}var u=(h.decorators=[{type:t.NgModule,args:[{declarations:[c],imports:[],exports:[c]}]}],h);function h(){}e.OpencamService=i,e.OpencamComponent=c,e.OpencamModule=u,e.ECaptureType=o,e.EStreamState=a,e.EMediaConstraints=s,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=ng-opencam.umd.min.js.map